# Lite monitoring system

## Легковесная система мониторинга

Легковесная система мониторинга доступности хостов, служб, сайтов для быстрого разворачивания и настройки с ориентацией на Telegram-уведомления.

Данная система представляет из себя службу, разработанную на языке Python 3.9

Служба включает в себя следующие модули мониторинга:
- URL-модуль для проверки доступности ресурсов по протоколу HTTP/S
- BURL-модуль, по сути аналог URL, но с возможностью проверки полученного контента
- SIP-модуль для проверки доступности сервера телефонии Asterisk методом отправки запроса OPTIONS
- MONGO-модуль для проверки доступности Primary базы данных Mongo, а также тесты поиска, записи и удаления коллекции
- SOCKET-модуль для проверки доступности сетевых служб хоста, либо самого хоста

Службу можно развернуть на хостах разных подсетей для мониторинга целевого объекта из разных точек локальной сети.

#### Конфигурация
Конфигурационный файл __должен__ находится по пути: __/etc/monsys/.env__
Данный файл имеет следующую структуру:
```
tg_bot_token=12345:tokenABC
chats_list=123 456 789 1011
message_postfix=[Monitoring system io]
is_tg_enabled=False
is_highlighter_enabled=False
highlighter_pause=7200
highlighter_problems_pause=900

```
- Параметр __tg_bot_token__ отвечает за токен телеграмм бота для уведомлений в Telegram.
Бот создается самостоятельно администратором.
- Параметр __chats_list__ включает перечисление ID-чатов в телеграмме, куда добавлен бот. В дальнейшем, начиная индексацию с 0 (0 чат используется для общих сообщений системы), эти чаты можно привязывать к каждой задаче (об этом далее).
- Параметр __message_postfix__ является декораторным и просто отвечает за оконечную часть уведомлений в сообщениях бота. Ее можно использовать, например, для указания адреса сервера, откуда выполняется мониторинг в локальной сети.
- Параметр __is_tg_enabled__ включает/выключает уведомления в телеграмм.
- Параметр __is_highlighter_enabled__ включает/выключает уведомление самомониторинга и оповещение о случившихся и текущих проблемах. При наличии актуальных проблемах приходит раз в  __highlighter_problems_pause__, по умолчанию - это параметр __highlighter_pause__, который измеряется в секундах.
Уведомления о проблемах приходят по аналогии с системой Zabbix.

#### Добавление задач мониторинга
Добавление задач осуществляется путем их добавления в файл, который __должен__ находиться по пути: __/etc/monsys/jobs_list__
Эталонные шаблоны данного файла, а также конфигурационного файла находятся в корне проекта в директории /templates
##### Пример добавления задачи
Допустим, необходимо проверять доступность сайта с определенной периодичностью с учетом наличия SSL-сертификата. Рассмотрим пример такой записи в шаблонном файле (внимательно читайте преамбулу файла-шаблона __jobs_list__, этот файл является частью документации):
```
[common_urls_module]    https://www.google.com/    ssl    Check Google    *    3    120    0
```
Задачи мониторинга работают в асинхронном режиме.
Задача представляет из себя запись в файле __jobs_list__.
Аргументы записи разделены 4 пробелами (НЕ ЗНАКОМ ТАБУЛЯЦИИ -- любой другой синтаксис приводит к ошибке сепарации конфигурационного файла, а в частности добавляемой задачи. Также не допускается использование больее 3 пробелов в названии задачи). Далее аргументы записи:
- __[common_urls_module]__ -- обозначает название модуля, к которому относится задача. Порядок перечисления задач в файле носит исключительно организационный характер;
- __https://www.google.com/__ -- URL проверяемого ресурса;
- __ssl__ -- требуется ли включать проверку SSL-сертификата;
- __Check Google__ -- Название задачи, допускаются пробелы;
- __*__ -- Ожидаемые коды ответа или * (без разницы);
- __3__ -- Время, сколько будет ожидаться ответ (таймаут) в секундах или * (по умолчанию 5).
Значения * по умолчанию из исходного кода (таймаут и интервал) в секундах:
```python
# defaults in secs
self.sip_timeout_default = 15
self.curl_timeout_default = 5
self.mongo_timeout_default = 5
self.socket_timeout_default = 5

self.sip_interval_default = 60
self.curl_interval_default = 60
self.mongo_interval_default = 60
self.socket_interval_default = 60
```
- __120__ -- интервал между отправляемыми запросами;
- __0__ -- ID телеграмм-чата (как элемента массива), куда будет отправлено уведомление в случае возникновения проблемы.


#### Осуществление запуска

Служба мониторинга может быть запущена как контейнер с помощью docker-compose (см. файлы в корне проекта), либо как "голый" Python-скрипт.
Пример скрипта запуска напрямую из корня проекта:
```sh
#!/bin/bash
set -e
mkdir /etc/monsys
cp ./templates/jobs_list.template /etc/monsys/jobs_list
cp ./templates/env.template /etc/monsys/.env
docker-compose up -d --build
cd /etc/monsys/
docker ps -a
cat jobs_list
```
Для обновления списка задач достаточно просто перезапустить скрипт или docker-контейнер.
